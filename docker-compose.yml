version: '3.8'

services:
  code-server-claude:
    image: ghcr.io/${GITHUB_REPOSITORY:-yourusername/docker-code-server}:latest
    container_name: code-server-claude
    environment:
      - PUID=${PUID:-1000}  # Pass through host user ID or default to 1000
      - PGID=${PGID:-1000}  # Pass through host group ID or default to 1000
      - TZ=${TZ:-Etc/UTC}
      - PASSWORD=${CODE_SERVER_PASSWORD:-password} # Optional password for code-server
      - SUDO_PASSWORD=${SUDO_PASSWORD:-password} # Optional sudo password
      - DEFAULT_WORKSPACE=/config/workspace # Default workspace
      - PROXY_DOMAIN=${PROXY_DOMAIN:-}  # Your domain (e.g., code.mydomain.com) for subdomain proxying
      - VSCODE_EXTENSIONS=${VSCODE_EXTENSIONS:-}  # Comma-separated list of extension IDs to install
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}  # OpenAI API key for using OpenAI services
      - GOOGLE_API_KEY=${GOOGLE_API_KEY:-}  # Google API key for Gemini CLI (alternative to OAuth)
      - CODE_SERVER_URL=${CODE_SERVER_URL:-}  # Your code-server URL (e.g., https://code.example.com) for OAuth proxy auto-conversion
    volumes:
      - ./config:/config
      - ./workspace:/config/workspace
      - /var/run/docker.sock:/var/run/docker.sock:ro # For Docker access
      # Optional: Add more volume mounts as needed
      # - ~/.ssh:/config/.ssh:ro # For SSH keys
      # - ~/.gitconfig:/config/.gitconfig:ro # For git config
    ports:
      - "8443:8443"
      - "4040:4040"   # Agentboard - AI agent session monitoring
    restart: unless-stopped
    # Optional: Add to enable GPU support
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]
    
    # Optional: Network configuration for docker commands
    # network_mode: host
    
    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8443/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s